/**
 * ===========================================================
 *   _____    _             _____  _____
 *  |  __ \  | |           / ____||  __ \  /\    
 *  | |__) | | |__   _ __ | (___  | |__) |/  \   
 *  |  ___/  | '_ \ | '_ \ \___ \ |  ___// /\ \  
 *  | |      | | | || |_) |____) || |   / ____ \ 
 *  |_|      |_| |_|| .__/|_____/ |_|  /_/    \_\
 *                  | |
 *                  |_|
 * 
 * ===========================================================
 * 
 * PhpSPA JavaScript Engine
 *
 * A lightweight JavaScript engine for PHP-powered single-page applications.
 * Handles SPA-style navigation, content replacement, and lifecycle events
 * without full page reloads. Designed to pair with the `PhpSPA` PHP framework.
 *
 * Note:
 * - All scripts and logic must be attached per component using `$component->script(...)`.
 * - This library assumes server-rendered HTML responses with placeholder target IDs.
 *
 * @author Dave Conco <me@dconco.tech>
 * @link https://github.com/dconco/phpspa-js
 * @version 2.0.1
 * @license MIT
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):("undefined"!=typeof window?window:"undefined"!=typeof self?self:this).phpspa=t()}("undefined"!=typeof self&&self,function(){"use strict";function e(e){try{return btoa(e)}catch(t){try{const t=(new TextEncoder).encode(e),n=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(n)}catch(t){return btoa(e.split("").map(function(e){return String.fromCharCode(255&e.charCodeAt(0))}).join(""))}}}var t;var n="undefined"==typeof document?void 0:document,r=!!n&&"content"in n.createElement("template"),o=!!n&&n.createRange&&"createContextualFragment"in n.createRange();function a(e){return e=e.trim(),r?function(e){var t=n.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):o?function(e){return t||(t=n.createRange()).selectNode(n.body),t.createContextualFragment(e).childNodes[0]}(e):function(e){var t=n.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function i(e,t){var n,r,o=e.nodeName,a=t.nodeName;return o===a||(n=o.charCodeAt(0),r=a.charCodeAt(0),n<=90&&r>=97?o===a.toUpperCase():r<=90&&n>=97&&a===o.toUpperCase())}function c(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var s={OPTION:function(e,t){var n=e.parentNode;if(n){var r=n.nodeName.toUpperCase();"OPTGROUP"===r&&(r=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==r||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}c(e,t,"selected")},INPUT:function(e,t){c(e,t,"checked"),c(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var r=e.firstChild;if(r){var o=r.nodeValue;if(o==n||!n&&o==e.placeholder)return;r.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,r,o=-1,a=0,i=e.firstChild;i;)if("OPTGROUP"===(r=i.nodeName&&i.nodeName.toUpperCase()))(i=(n=i).firstChild)||(i=n.nextSibling,n=null);else{if("OPTION"===r){if(i.hasAttribute("selected")){o=a;break}a++}!(i=i.nextSibling)&&n&&(i=n.nextSibling,n=null)}e.selectedIndex=o}}};function d(){}function l(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var u=function(e){return function(t,r,o){if(o||(o={}),"string"==typeof r)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var c=r;(r=n.createElement("html")).innerHTML=c}else r=a(r);else 11===r.nodeType&&(r=r.firstElementChild);var u=o.getNodeKey||l,f=o.onBeforeNodeAdded||d,p=o.onNodeAdded||d,h=o.onBeforeElUpdated||d,m=o.onElUpdated||d,g=o.onBeforeNodeDiscarded||d,y=o.onNodeDiscarded||d,S=o.onBeforeElChildrenUpdated||d,v=o.skipFromChildren||d,C=o.addChild||function(e,t){return e.appendChild(t)},E=!0===o.childrenOnly,b=Object.create(null),x=[];function T(e){x.push(e)}function w(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var r=void 0;t&&(r=u(n))?T(r):(y(n),n.firstChild&&w(n,t)),n=n.nextSibling}}function A(e,t,n){!1!==g(e)&&(t&&t.removeChild(e),y(e),w(e,n))}function N(e){if(1===e.nodeType||11===e.nodeType)for(var t=e.firstChild;t;){var n=u(t);n&&(b[n]=t),N(t),t=t.nextSibling}}function I(e){p(e);for(var t=e.firstChild;t;){var n=t.nextSibling,r=u(t);if(r){var o=b[r];o&&i(t,o)?(t.parentNode.replaceChild(o,t),R(o,t)):I(t)}else I(t);t=n}}function R(t,r,o){var a=u(r);if(a&&delete b[a],!o){var c=h(t,r);if(!1===c)return;if(c instanceof HTMLElement&&N(t=c),e(t,r),m(t),!1===S(t,r))return}"TEXTAREA"!==t.nodeName?function(e,t){var r,o,a,c,d,l=v(e,t),p=t.firstChild,h=e.firstChild;e:for(;p;){for(c=p.nextSibling,r=u(p);!l&&h;){if(a=h.nextSibling,p.isSameNode&&p.isSameNode(h)){p=c,h=a;continue e}o=u(h);var m=h.nodeType,g=void 0;if(m===p.nodeType&&(1===m?(r?r!==o&&((d=b[r])?a===d?g=!1:(e.insertBefore(d,h),o?T(o):A(h,e,!0),o=u(h=d)):g=!1):o&&(g=!1),(g=!1!==g&&i(h,p))&&R(h,p)):3!==m&&8!=m||(g=!0,h.nodeValue!==p.nodeValue&&(h.nodeValue=p.nodeValue))),g){p=c,h=a;continue e}o?T(o):A(h,e,!0),h=a}if(r&&(d=b[r])&&i(d,p))l||C(e,d),R(d,p);else{var y=f(p);!1!==y&&(y&&(p=y),p.actualize&&(p=p.actualize(e.ownerDocument||n)),C(e,p),I(p))}p=c,h=a}!function(e,t,n){for(;t;){var r=t.nextSibling;(n=u(t))?T(n):A(t,e,!0),t=r}}(e,h,o);var S=s[e.nodeName];S&&S(e,t)}(t,r):s.TEXTAREA(t,r)}N(t);var O,D,P=t,U=P.nodeType,L=r.nodeType;if(!E)if(1===U)1===L?i(t,r)||(y(t),P=function(e,t){for(var n=e.firstChild;n;){var r=n.nextSibling;t.appendChild(n),n=r}return t}(t,(O=r.nodeName,(D=r.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==D?n.createElementNS(D,O):n.createElement(O)))):P=r;else if(3===U||8===U){if(L===U)return P.nodeValue!==r.nodeValue&&(P.nodeValue=r.nodeValue),P;P=r}if(P===r)y(t);else{if(r.isSameNode&&r.isSameNode(P))return;if(R(P,r,E),x)for(var B=0,k=x.length;B<k;B++){var H=b[x[B]];H&&A(H,H.parentNode,!1)}}return!E&&P!==t&&t.parentNode&&(P.actualize&&(P=P.actualize(t.ownerDocument||n)),t.parentNode.replaceChild(P,t)),P}}(function(e,t){var n,r,o,a,i=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var c=i.length-1;c>=0;c--)r=(n=i[c]).name,o=n.namespaceURI,a=n.value,o?(r=n.localName||r,e.getAttributeNS(o,r)!==a&&("xmlns"===n.prefix&&(r=n.name),e.setAttributeNS(o,r,a))):e.getAttribute(r)!==a&&e.setAttribute(r,a);for(var s=e.attributes,d=s.length-1;d>=0;d--)r=(n=s[d]).name,(o=n.namespaceURI)?(r=n.localName||r,t.hasAttributeNS(o,r)||e.removeAttributeNS(o,r)):t.hasAttribute(r)||e.removeAttribute(r)}});window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("[data-phpspa-target]"),t=document.querySelector("[phpspa-target-data]"),n=location.toString();if(p.emit("load",{route:n,success:!0,error:!1}),e){const r={url:n,title:document.title,targetID:e.id,content:e.innerHTML,root:!0};if(e.hasAttribute("phpspa-reload-time")&&(r.reloadTime=Number(e.getAttribute("phpspa-reload-time"))),t){const o=t.getAttribute("phpspa-target-data"),a=JSON.parse(function(e){try{const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return(new TextDecoder).decode(n)}catch(t){return atob(e)}}(o));a.targetIDs.forEach((t,o)=>{const i=a.exact[o],c=a.defaultContent[o];t===e.id&&(r.exact=i,r.defaultContent=c),p.currentRoutes[t]={route:new URL(a.currentRoutes[o],n),defaultContent:c,exact:i}})}p.replaceState(r,document.title,n),e.hasAttribute("phpspa-reload-time")&&setTimeout(f.reloadComponent,r.reloadTime)}}),document.addEventListener("click",e=>{const t=e.target.closest('a[data-type="phpspa-link-tag"]');t&&(e.preventDefault(),f.navigate(new URL(t.href,location.href),"push"))}),window.addEventListener("popstate",e=>{const t=e.state;if(p.emit("beforeload",{route:location.toString()}),history.scrollRestoration="auto",t&&t.content){document.title=t.title??document.title;const e=document.getElementById(t.targetID)??document.body;t.targetID&&(p.currentRoutes[t.targetID]={route:t.url,exact:t.exact,defaultContent:t.defaultContent});const n=p.currentRoutes;for(const e in n){if(!Object.hasOwn(n,e))continue;const r=n[e];if(!0===r.exact&&e!==t.targetID){let t=document.getElementById(e);if(t)try{u(t,"<div>"+r.defaultContent+"</div>",{childrenOnly:!0})}catch{t.innerHTML=r.defaultContent}delete n[e]}}const r=()=>{try{u(e,"<div>"+t.content+"</div>",{childrenOnly:!0})}catch{e.innerHTML=t.content}},o=()=>{p.clearEffects(),p.clearExecutedScripts(),p.runAll(),void 0!==t.reloadTime&&setTimeout(f.reloadComponent,t.reloadTime),p.emit("load",{route:t.url,success:!0,error:!1})};document.startViewTransition?document.startViewTransition(r).finished.then(o).catch(e=>{p.emit("load",{route:location.href,success:!1,error:e||"Unknown error during view transition"})}):(r(),o())}else f.navigate(location.toString(),"replace")});class f{static navigate(e,t="push"){function n(t){t.response?t.response.text().then(n=>{let o;try{o=n.trim().startsWith("{")?JSON.parse(n):n}catch(e){o=n}r(o||""),p.emit("load",{route:e?.toString()||e,success:!1,error:t.message||"Server returned an error",data:o})}).catch(()=>{r(""),p.emit("load",{route:e?.toString()||e,success:!1,error:t.message||"Failed to read error response"})}):(r(""),p.emit("load",{route:e?.toString()||e,success:!1,error:t.message||"No connection to server"}))}function r(n){String(n?.title).length>0&&(document.title=n.title);const r=document.getElementById(n?.targetID)??document.getElementById(history.state?.targetID)??document.body;n.targetID&&(p.currentRoutes[n.targetID]={route:e,exact:n.exact,defaultContent:p.currentRoutes[n.targetID]?.defaultContent??(document.getElementById(n.targetID)?.innerHTML||"")});const o=p.currentRoutes;for(const e in o){if(!Object.hasOwn(o,e))continue;const t=o[e];if(!0===t.exact&&e!==n?.targetID){let n=document.getElementById(e);if(n)try{u(n,"<div>"+t.defaultContent+"</div>",{childrenOnly:!0})}catch{n.innerHTML=t.defaultContent}delete o[e]}}const a=()=>{try{u(r,"<div>"+n?.content||n+"</div>",{childrenOnly:!0})}catch{r.innerHTML=n?.content?n.content:n}},i={url:e?.toString()??e,title:n?.title??document.title,targetID:n?.targetID??r.id,content:n?.content??n,exact:o[n?.targetID].exact,defaultContent:o[n?.targetID].defaultContent};void 0!==n.reloadTime&&(i.reloadTime=n.reloadTime);const c=()=>{"push"===t?p.pushState(i,i.title,e):"replace"===t&&p.replaceState(i,i.title,e);const r=document.getElementById(e?.hash?.substring(1));r?scroll({top:r.offsetTop,left:r.offsetLeft}):scroll(0,0),p.clearEffects(),p.clearExecutedScripts(),p.runAll(),p.emit("load",{route:e?.toString()||e,success:!0,error:!1}),void 0!==n.reloadTime&&setTimeout(f.reloadComponent,n.reloadTime)};document.startViewTransition?document.startViewTransition(a).finished.then(c).catch(t=>{p.emit("load",{route:e?.toString()||e,success:!1,error:t||"Unknown error during view transition"})}):(a(),c())}e=e instanceof URL?e:new URL(e,location.href),p.emit("beforeload",{route:e}),fetch(e,{headers:{"X-Requested-With":"PHPSPA_REQUEST","X-Phpspa-Target":"navigate"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(e=>{e.text().then(e=>{let t;if(e&&e.trim().startsWith("{"))try{t=JSON.parse(e)}catch(n){t=e}else t=e||"";r(t)}).catch(e=>n(e))}).catch(e=>n(e))}static back(){history.back()}static forward(){history.forward()}static reload(){f.navigate(location.toString(),"replace")}static on(e,t){p.events[e]||(p.events[e]=[]),p.events[e].push(t)}static useEffect(e,t=null){p.registerEffect(e,t)}static setState(t,n){return new Promise(async(r,o)=>{const a=p.currentRoutes,i=JSON.stringify({state:{key:t,value:n}}),c=[];for(const t in a){if(!Object.hasOwn(a,t))continue;const{route:n}=a[t],r=fetch(n,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(i)}`},mode:"same-origin",redirect:"follow",keepalive:!0});c.push(r)}function s(e){String(e.title).length>0&&(document.title=e.title);const r=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{u(r,"<div>"+e?.content||e+"</div>",{childrenOnly:!0})}catch{r.innerHTML=e?.content?e.content:e}})(),p.triggerEffects(t,n)}(await Promise.all(c)).forEach(async e=>{try{const t=await e.text();let n;if(t&&t.trim().startsWith("{"))try{n=JSON.parse(t)}catch(e){n=t}else n=t||"";r(),s(n)}catch(e){o(e.message),function(e){e.response?e.response.text().then(e=>{let t;try{t=e.trim().startsWith("{")?JSON.parse(e):e}catch(n){t=e}s(t||"")}).catch(()=>{s("")}):s("")}(e)}})})}static reloadComponent(){function e(e){e.response?e.response.text().then(e=>{let n;try{n=e.trim().startsWith("{")?JSON.parse(e):e}catch(t){n=e}t(n||"")}).catch(()=>{t("")}):t("")}function t(e){"string"!=typeof e?.title&&"number"!=typeof e?.title||(document.title=e.title);const t=document.getElementById(e?.targetID)??document.getElementById(history.state?.targetID)??document.body;(()=>{try{u(t,"<div>"+e?.content||e+"</div>",{childrenOnly:!0})}catch{t.innerHTML=e?.content||e}})(),p.clearEffects(),p.clearExecutedScripts(),p.runAll(),void 0!==e.reloadTime&&setTimeout(f.reloadComponent,e.reloadTime)}fetch(location.toString(),{headers:{"X-Requested-With":"PHPSPA_REQUEST"},mode:"same-origin",redirect:"follow",keepalive:!0}).then(n=>{n.text().then(e=>{let n;if(e&&e.trim().startsWith("{"))try{n=JSON.parse(e)}catch(t){n=e}else n=e||"";t(n)}).catch(t=>{e(t)})}).catch(t=>{e(t)})}static async __call(t,...n){const r=new URL(location.toString()),o=JSON.stringify({__call:{token:t,args:n}});try{const t=await fetch(r,{headers:{"X-Requested-With":"PHPSPA_REQUEST",Authorization:`Bearer ${e(o)}`},mode:"same-origin",redirect:"follow",keepalive:!0}),n=await t.text();let a;if(n&&n.trim().startsWith("{"))try{a=JSON.parse(n),a=a?.response?JSON.parse(a.response):a}catch(e){a=n}else a=n||"";return a}catch(e){if(!e.response)return"";try{const t=await e.response.text();let n;try{n=t.trim().startsWith("{")?JSON.parse(t):t,n=n?.response?JSON.parse(n.response):n}catch(e){n=t}return n}catch{return""}}}}class p{static executedScripts=new Set;static executedStyles=new Set;static ScriptsCachedContent={};static currentRoutes={};static events={beforeload:[],load:[]};static effects=new Set;static registerEffect(e,t=null){const n=e(),r={callback:e,dependencies:t,cleanup:"function"==typeof n?n:null};p.effects.add(r)}static triggerEffects(e,t){p.effects.forEach(t=>{if(null===t.dependencies||t.dependencies.includes(e)){t.cleanup&&t.cleanup();const e=t.callback();t.cleanup="function"==typeof e?e:null}})}static clearEffects(){p.effects.forEach(e=>{e.cleanup&&e.cleanup()}),p.effects.clear()}static runAll(){for(const e in p.currentRoutes){const t=document.getElementById(e);t&&(this.runInlineScripts(t),this.runPhpSpaScripts(t),this.runInlineStyles(t))}}static runInlineScripts(t){const n=t.querySelectorAll("script"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedScripts.has(n)&&""!==t.textContent.trim()){this.executedScripts.add(n);const e=document.createElement("script");e.nonce=r;for(const n of t.attributes)e.setAttribute(n.name,n.value);const o=t.hasAttribute("async");e.textContent=o?`(async function() {\n${t.textContent}\n})();`:`(function() {\n${t.textContent}\n})();`,document.head.appendChild(e).remove()}})}static runPhpSpaScripts(e){e.querySelectorAll('phpspa-script, script[data-type="phpspa/script"]').forEach(async e=>{const t=e.getAttribute("src"),n=e.getAttribute("type"),r=document.documentElement.getAttribute("x-phpspa");if(!this.executedScripts.has(t)){if(this.executedScripts.add(t),this.ScriptsCachedContent[t]){const e=document.createElement("script");return e.textContent=this.ScriptsCachedContent[t],e.type=n,e.nonce=r,void document.head.appendChild(e).remove()}const e=await fetch(t,{headers:{"X-Requested-With":"PHPSPA_REQUEST_SCRIPT"}});if(e.ok){const o=await e.text(),a=document.createElement("script");a.textContent=o,a.type=n,a.nonce=r,document.head.appendChild(a).remove(),this.ScriptsCachedContent[t]=o}else console.error(`Failed to load script from ${t}: ${e.statusText}`)}})}static clearExecutedScripts(){p.executedScripts.clear()}static runInlineStyles(t){const n=t.querySelectorAll("style"),r=document.documentElement.getAttribute("x-phpspa");n.forEach(t=>{const n=e(t.textContent.trim());if(!this.executedStyles.has(n)&&""!==t.textContent.trim()){this.executedStyles.add(n);const e=document.createElement("style");e.nonce=r;for(const n of t.attributes)e.setAttribute(n.name,n.value);e.textContent=t.textContent,document.head.appendChild(e).remove()}})}static emit(e,t){const n=this.events[e]||[];for(const r of n)if("function"==typeof r)try{r(t)}catch(t){console.error(`Error in ${e} event callback:`,t)}}static pushState(...e){try{history.pushState(...e)}catch(e){console.warn("Failed to push history state:",e.message)}}static replaceState(...e){try{history.replaceState(...e)}catch(e){console.warn("Failed to replace history state:",e.message)}}}return"undefined"!=typeof window&&("function"!=typeof window.setState&&(window.setState=f.setState),"function"!=typeof window.__call&&(window.__call=f.__call),"function"!=typeof window.useEffect&&(window.useEffect=f.useEffect)),f});